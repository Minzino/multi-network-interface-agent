apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "multinic-agent.fullname" . }}-crd-update
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 120
  template:
    metadata:
      name: {{ include "multinic-agent.fullname" . }}-crd-update
    spec:
      serviceAccount: {{ include "multinic-agent.serviceAccountName" . }}
      restartPolicy: Never
      containers:
      - name: crd-update
        image: bitnami/kubectl:latest
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        - |
          echo "ğŸ”§ MultiNIC Agent CRD ì—…ë°ì´íŠ¸ ì‹œì‘..."
          
          # CRD ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if kubectl get crd multinicnodeconfigs.multinic.io >/dev/null 2>&1; then
            echo "ğŸ“‹ ê¸°ì¡´ CRD ë°œê²¬ - replace ë°©ì‹ìœ¼ë¡œ ì—…ë°ì´íŠ¸..."
            
            # ê¸°ì¡´ CRDë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ìƒì„±
            kubectl delete crd multinicnodeconfigs.multinic.io --ignore-not-found=true
            echo "â³ CRD ì‚­ì œ ì™„ë£Œ, 5ì´ˆ ëŒ€ê¸°..."
            sleep 5
          else
            echo "ğŸ“‹ ìƒˆë¡œìš´ CRD ìƒì„±..."
          fi
          
          # ìƒˆ CRD ì ìš©
          kubectl apply -f - <<'EOF'
{{ .Files.Get "files/crds/multinicnodeconfig-crd.yaml" | indent 10 }}
          EOF
          
          if [ $? -eq 0 ]; then
            echo "âœ… CRD ì—…ë°ì´íŠ¸ ì™„ë£Œ"
            
            # CRDê°€ ì™„ì „íˆ ì ìš©ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            echo "â³ CRD ì ìš© ëŒ€ê¸° ì¤‘..."
            sleep 10
            
            echo "ğŸ“‹ CRD ìƒíƒœ í™•ì¸:"
            kubectl get crd multinicnodeconfigs.multinic.io -o jsonpath='{.metadata.name}: ìƒì„±ë¨' 2>/dev/null || echo "CRD í™•ì¸ ì‹¤íŒ¨"
            
            # ìŠ¤í‚¤ë§ˆ í•„ë“œ í™•ì¸
            echo "ğŸ” interfaceStatuses í•„ë“œ í™•ì¸:"
            kubectl get crd multinicnodeconfigs.multinic.io -o jsonpath='{.spec.versions[0].schema.openAPIV3Schema.properties.status.properties.interfaceStatuses.items.properties}' 2>/dev/null | grep -o '"[^"]*"' | head -5 || echo "ìŠ¤í‚¤ë§ˆ í™•ì¸ ì‹¤íŒ¨"
          else
            echo "âŒ CRD ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"
            exit 1
          fi