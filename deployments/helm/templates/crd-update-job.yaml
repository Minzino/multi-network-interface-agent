apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "multinic-agent.fullname" . }}-crd-update
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      name: {{ include "multinic-agent.fullname" . }}-crd-update
    spec:
      serviceAccount: {{ include "multinic-agent.serviceAccountName" . }}
      restartPolicy: Never
      containers:
      - name: crd-update
        image: bitnami/kubectl:latest
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        - |
          echo "ğŸ”§ MultiNIC Agent CRD ì—…ë°ì´íŠ¸ ì‹œì‘..."
          
          # CRD ì—…ë°ì´íŠ¸ ì ìš©
          kubectl apply -f - <<'EOF'
{{ .Files.Get "crds/multinicnodeconfig-crd.yaml" | indent 10 }}
          EOF
          
          if [ $? -eq 0 ]; then
            echo "âœ… CRD ì—…ë°ì´íŠ¸ ì™„ë£Œ"
            
            # CRDê°€ ì™„ì „íˆ ì ìš©ë  ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸°
            echo "â³ CRD ì ìš© ëŒ€ê¸° ì¤‘..."
            sleep 5
            
            echo "ğŸ“‹ CRD ìƒíƒœ í™•ì¸:"
            kubectl get crd multinicnodeconfigs.multinic.io -o jsonpath='{.metadata.name}: {.spec.versions[0].schema.openAPIV3Schema.properties.status.properties.interfaceStatuses.items.properties}' | grep -o '"[^"]*"' | head -10
          else
            echo "âŒ CRD ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"
            exit 1
          fi
      ttlSecondsAfterFinished: 120